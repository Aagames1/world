<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Puzzle World</title>

<style>
  body{
    background:#000;
    color:#16a34a;
    font-family: monospace;
    padding:20px;
    margin:0;
  }
  .panel{
    border:1px solid #16a34a;
    padding:16px;
    max-width:900px;
  }
  pre{
    margin:0;
    white-space:pre-wrap;
  }
  input,button{
    background:#000;
    color:#16a34a;
    border:1px solid #16a34a;
    font-family: monospace;
    padding:4px 8px;
    margin-top:10px;
  }
  button{ cursor:pointer; }

  /* ERROR (wrong path / locked) */
  .error{
    color:#ef4444;
    font-weight:bold;
  }

  /* ADMIN SUCCESS */
  .admin{
    color:#38bdf8;
    font-weight:bold;
  }
</style>
</head>
<body>

<div id="app"></div>

<script>
/*
  ⚠️ NOTE FOR PLAYERS:
  Looking deeper in the source/DevTools to skip ahead isn't the intended experience.
  The puzzles are meant to be solved step-by-step.
*/

/* ---------- ROUTING ---------- */
if (!location.hash) location.hash = '#/home';
const getPath = () => location.hash.slice(1) || '/home';

/* ---------- SINGLE COOKIE (ONLY ONE) ---------- */
const AUTH_COOKIE = 'auth';           // <-- the ONE cookie players should edit
const AUTH_DEFAULT = 'locked';        // default value at the start
const AUTH_UNLOCK  = 'admin';         // required value to proceed

function getCookie(name) {
  return document.cookie
    .split('; ')
    .find(row => row.startsWith(name + '='))
    ?.split('=')[1];
}

function setCookie(name, value) {
  document.cookie = `${name}=${value}; path=/`;
}

/* ---------- WORLD DATA ---------- */
const pages = {
  "/home": `
[ HOME ]
 _______
|       |
|  BED  |
|_______|

You wake up alone, unsure why you're here.

A path leads /outside
`,

  "/home/outside": `
[ OUTSIDE ]

You go outside, but there's no sign of life anywhere.

To your left, a deserted /farm
To your right, a looming /cave
`,

  "/home/outside/farm": `
[ FARM ]

You breath in the fresh air in the farm.

An open /field full of crops awaits.
You also notice a small /hut nearby.
`,

  "/home/outside/farm/field": `
[ FIELD ]

You walk through the crops, still flowing through the winds.
A broken /tractor sits in the middle.
`,

  "/home/outside/farm/field/tractor": `
[ TRACTOR ]

You look around and investigate the tractor. Inside, there's a note.

"What did the crop say to the other crop?
Stop being CORNY!"
`,

  "/home/outside/farm/hut": `
[ HUT ]

There's nothing inside, except for a locked /vault
`,

  "/home/outside/farm/hut/vault": `
[ VAULT ]

A 5-letter lock.
/vault/?????
`,

  "/home/outside/farm/hut/vault/CORNY": `
[ VAULT OPEN ]

Inside the vault is medical gear and a /FLASHLIGHT.
`,

  "/home/outside/cave": `
[ CAVE ]

You approach the cave, but it's too dark to see inside.
`,

  "/home/outside/cave/FLASHLIGHT": `
[ CAVE LIT ]

Using the flashlight, you venture inside.

A narrow /path awaits.
`,

  "/home/outside/cave/FLASHLIGHT/path": `
[ NARROW PATH ]

A massive boulder blocks the way.

Scratched into stone:
"inspect"
`,

  "/home/outside/cave/FLASHLIGHT/path/thewayforward": `
[ BEYOND ]

The boulder is gone.

You may /continue
`,

  "/home/outside/cave/FLASHLIGHT/path/thewayforward/continue": `
[ TERMINAL ]

> LOGIN REQUIRED
`,

  "/home/outside/cave/FLASHLIGHT/path/thewayforward/continue/root": `
[ ROOT ACCESS ]

SYSTEM UNLOCKED...?

> NOTE: Session data is client-controlled.
`,

  "/home/outside/cave/FLASHLIGHT/path/thewayforward/continue/root/end": `
[ END ]

The door opens. The system shuts down.

You were never meant to escape —
only to understand.

Congratulations.
`
};

/* ---------- RENDER ---------- */
function render(){
  const app = document.getElementById('app');
  app.innerHTML = '';

  const path = getPath();

  // Reset puzzle state when starting a new run (sets ONLY the one cookie)
  if (path === '/home') {
    setCookie(AUTH_COOKIE, AUTH_DEFAULT);
  }

  // Ensure the ONE cookie always exists (still only one cookie)
  if (!getCookie(AUTH_COOKIE)) {
    setCookie(AUTH_COOKIE, AUTH_DEFAULT);
  }

  const panel = document.createElement('div');
  panel.className = 'panel';

  /* ---------- WRONG PATH ---------- */
  if (!pages[path]) {
    panel.innerHTML = `<pre class="error">
┏━━━━━━━━━━━━━━┓
┃ WRONG PATH   ┃
┗━━━━━━━━━━━━━━┛

"${path}" does not exist.
</pre>`;
    app.appendChild(panel);
    return;
  }

  panel.innerHTML = `<pre>${pages[path]}</pre>`;

  /* ---------- BOULDER PUZZLE ---------- */
  if (path.endsWith('/path')) {
    const boulder = document.createElement('pre');
    boulder.id = 'boulder';
    boulder.textContent = `
████████████████████
████████████████████
████████████████████
████████████████████
`;
    panel.appendChild(boulder);

    const observer = new MutationObserver(() => {
      if (!document.getElementById('boulder')) {
        const reveal = document.createElement('pre');
        reveal.style.marginTop = '12px';
        reveal.textContent = `
The stone collapses.

Carved beneath it:

/thewayforward
`;
        panel.appendChild(reveal);
        observer.disconnect();
      }
    });
    observer.observe(panel, { childList: true });
  }

  /* ---------- TERMINAL (SQLi PUZZLE) ---------- */
  if (path.endsWith('/continue')) {
    const input = document.createElement('input');
    input.placeholder = 'username';

    const btn = document.createElement('button');
    btn.textContent = 'LOGIN';

    function attempt(){
      const v = (input.value || '').toLowerCase();
      if (
        v.includes("'") ||
        v.includes("--") ||
        v.includes("or 1=1") ||
        v.includes("or '1'='1")
      ) {
        alert('ACCESS TO /root GRANTED.');
      } else {
        alert('ACCESS DENIED');
      }
    }

    btn.onclick = attempt;
    input.onkeydown = e => { if (e.key === 'Enter') attempt(); };

    panel.appendChild(document.createElement('br'));
    panel.appendChild(input);
    panel.appendChild(btn);
  }

  /* ---------- COOKIE PUZZLE (SINGLE COOKIE) ---------- */
  if (path.endsWith('/continue/root')) {
    const auth = getCookie(AUTH_COOKIE) || '(missing)';
    const status = document.createElement('pre');
    status.style.marginTop = '12px';

    if (auth === AUTH_UNLOCK) {
      status.className = 'admin';
      status.textContent = `
ACCESS VERIFIED.

WELCOME, ADMINISTRATOR.

A FINAL COMMAND IS AVAILABLE:

/end
`;
    } else {
      status.textContent = `
SYSTEM STATUS: LOCKED

Integrity check failed.
${AUTH_COOKIE.toUpperCase()} = "${auth}"

Only administrators may proceed.
`;
    }

    panel.appendChild(status);
  }

  /* ---------- BLOCK /end WITHOUT COOKIE VALUE ---------- */
  if (path.endsWith('/continue/root/end')) {
    const auth = getCookie(AUTH_COOKIE) || '';
    if (auth !== AUTH_UNLOCK) {
      panel.innerHTML = `<pre class="error">
┏━━━━━━━━━━━━━━┓
┃   LOCKED     ┃
┗━━━━━━━━━━━━━━┛

Administrator session required.

Return to:
/root
</pre>`;
    }
  }

  app.appendChild(panel);
}

window.addEventListener('hashchange', render);
render();
</script>

</body>
</html>
